#include "Nokia5110.h"

int reset_pin_;
int dc_pin_;

enum { LCD_WIDTH = 84, LCD_HEIGHT = 48 };
enum { FONT_WIDTH = 6, FONT_HEIGHT = 8 };
enum { COLUMNS = LCD_WIDTH / FONT_WIDTH, ROWS = LCD_HEIGHT / FONT_HEIGHT };

char tbuff_[LCD_WIDTH * FONT_WIDTH];
char rbuff_[LCD_WIDTH * FONT_WIDTH];
char vram_[LCD_WIDTH * FONT_WIDTH];

// Raspberry Pi logo data
const char rpi_logo_[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0010 (16) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0xFC, 0xAE, 0x0E, 0x0E, 0x06, 0x0E, 0x06,   // 0x0020 (32) pixels
  0xCE, 0x86, 0x8E, 0x0E, 0x0E, 0x1C, 0xB8, 0xF0, 0xF8, 0x78, 0x38, 0x1E, 0x0E, 0x8E, 0x8E, 0xC6,   // 0x0030 (48) pixels
  0x0E, 0x06, 0x0E, 0x06, 0x0E, 0x9E, 0xFE, 0xFC, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0040 (64) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0050 (80) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0060 (96) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x0F, 0xFE,   // 0x0070 (112) pixels
  0xF8, 0xF0, 0x60, 0x60, 0xE0, 0xE1, 0xE3, 0xF7, 0x7E, 0x3E, 0x1E, 0x1F, 0x1F, 0x1F, 0x3E, 0x7E,   // 0x0080 (128) pixels
  0xFB, 0xF3, 0xE1, 0xE0, 0x60, 0x70, 0xF0, 0xF8, 0xBE, 0x1F, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x00,   // 0x0090 (144) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x00A0 (160) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x00B0 (176) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,   // 0x00C0 (192) pixels
  0xE0, 0xFC, 0xFE, 0xFF, 0xF3, 0x38, 0x38, 0x0C, 0x0E, 0x0F, 0x0F, 0x0F, 0x0E, 0x3C, 0x38, 0xF8,   // 0x00D0 (208) pixels
  0xF8, 0x38, 0x3C, 0x0E, 0x0F, 0x0F, 0x0F, 0x0E, 0x0C, 0x38, 0x38, 0xF3, 0xFF, 0xFF, 0xF8, 0xE0,   // 0x00E0 (224) pixels
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x00F0 (240) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0100 (256) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0110 (272) pixels
  0x00, 0x7F, 0xFF, 0xE7, 0xC3, 0xC1, 0xE0, 0xFF, 0xFF, 0x78, 0xE0, 0xC0, 0xC0, 0xC0, 0xC0, 0xE0,   // 0x0120 (288) pixels
  0x60, 0x78, 0x38, 0x3F, 0x3F, 0x38, 0x38, 0x60, 0x60, 0xC0, 0xC0, 0xC0, 0xC0, 0xE0, 0xF8, 0x7F,   // 0x0130 (304) pixels
  0xFF, 0xE0, 0xC1, 0xC3, 0xE7, 0x7F, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0140 (320) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0150 (336) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0160 (352) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x7F, 0xFF, 0xF1, 0xE0, 0xC0, 0x80, 0x01,   // 0x0170 (368) pixels
  0x03, 0x9F, 0xFF, 0xF0, 0xE0, 0xE0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xE0, 0xE0, 0xF0, 0xFF, 0x9F,   // 0x0180 (384) pixels
  0x03, 0x01, 0x80, 0xC0, 0xE0, 0xF1, 0x7F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0190 (400) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x01A0 (416) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x01B0 (432) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,   // 0x01C0 (448) pixels
  0x03, 0x03, 0x07, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x3B, 0x71, 0x60, 0x60, 0x60, 0x60, 0x60, 0x71,   // 0x01D0 (464) pixels
  0x3B, 0x1F, 0x0F, 0x0F, 0x0F, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x01E0 (480) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x01F0 (496) pixels
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

// Font data
const char ascii_[][FONT_WIDTH] = {
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* 20   */
  {0x00, 0x00, 0x5f, 0x00, 0x00, 0x00}, /* 21 ! */
  {0x00, 0x07, 0x00, 0x07, 0x00, 0x00}, /* 22 " */
  {0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00}, /* 23 # */
  {0x24, 0x2a, 0x7f, 0x2a, 0x12, 0x00}, /* 24 $ */
  {0x23, 0x13, 0x08, 0x64, 0x62, 0x00}, /* 25 % */
  {0x36, 0x49, 0x55, 0x22, 0x50, 0x00}, /* 26 & */
  {0x00, 0x05, 0x03, 0x00, 0x00, 0x00}, /* 27 ' */
  {0x00, 0x1c, 0x22, 0x41, 0x00, 0x00}, /* 28 ( */
  {0x00, 0x41, 0x22, 0x1c, 0x00, 0x00}, /* 29 ) */
  {0x14, 0x08, 0x3e, 0x08, 0x14, 0x00}, /* 2a * */
  {0x08, 0x08, 0x3e, 0x08, 0x08, 0x00}, /* 2b + */
  {0x00, 0x50, 0x30, 0x00, 0x00, 0x00}, /* 2c , */
  {0x08, 0x08, 0x08, 0x08, 0x08, 0x00}, /* 2d - */
  {0x00, 0x60, 0x60, 0x00, 0x00, 0x00}, /* 2e , */
  {0x20, 0x10, 0x08, 0x04, 0x02, 0x00}, /* 2f / */
  {0x3e, 0x51, 0x49, 0x45, 0x3e, 0x00}, /* 30 0 */
  {0x00, 0x42, 0x7f, 0x40, 0x00, 0x00}, /* 31 1 */
  {0x42, 0x61, 0x51, 0x49, 0x46, 0x00}, /* 32 2 */
  {0x21, 0x41, 0x45, 0x4b, 0x31, 0x00}, /* 33 3 */
  {0x18, 0x14, 0x12, 0x7f, 0x10, 0x00}, /* 34 4 */
  {0x27, 0x45, 0x45, 0x45, 0x39, 0x00}, /* 35 5 */
  {0x3c, 0x4a, 0x49, 0x49, 0x30, 0x00}, /* 36 6 */
  {0x01, 0x71, 0x09, 0x05, 0x03, 0x00}, /* 37 7 */
  {0x36, 0x49, 0x49, 0x49, 0x36, 0x00}, /* 38 8 */
  {0x06, 0x49, 0x49, 0x29, 0x1e, 0x00}, /* 39 9 */
  {0x00, 0x36, 0x36, 0x00, 0x00, 0x00}, /* 3a : */
  {0x00, 0x56, 0x36, 0x00, 0x00, 0x00}, /* 3b ; */
  {0x08, 0x14, 0x22, 0x41, 0x00, 0x00}, /* 3c < */
  {0x14, 0x14, 0x14, 0x14, 0x14, 0x00}, /* 3d = */
  {0x00, 0x41, 0x22, 0x14, 0x08, 0x00}, /* 3e > */
  {0x02, 0x01, 0x51, 0x09, 0x06, 0x00}, /* 3f ? */
  {0x32, 0x49, 0x79, 0x41, 0x3e, 0x00}, /* 40 @ */
  {0x7e, 0x11, 0x11, 0x11, 0x7e, 0x00}, /* 41 A */
  {0x7f, 0x49, 0x49, 0x49, 0x36, 0x00}, /* 42 B */
  {0x3e, 0x41, 0x41, 0x41, 0x22, 0x00}, /* 43 C */
  {0x7f, 0x41, 0x41, 0x22, 0x1c, 0x00}, /* 44 D */
  {0x7f, 0x49, 0x49, 0x49, 0x41, 0x00}, /* 45 E */
  {0x7f, 0x09, 0x09, 0x09, 0x01, 0x00}, /* 46 F */
  {0x3e, 0x41, 0x49, 0x49, 0x7a, 0x00}, /* 47 G */
  {0x7f, 0x08, 0x08, 0x08, 0x7f, 0x00}, /* 48 H */
  {0x00, 0x41, 0x7f, 0x41, 0x00, 0x00}, /* 49 I */
  {0x20, 0x40, 0x41, 0x3f, 0x01, 0x00}, /* 4a J */
  {0x7f, 0x08, 0x14, 0x22, 0x41, 0x00}, /* 4b K */
  {0x7f, 0x40, 0x40, 0x40, 0x40, 0x00}, /* 4c L */
  {0x7f, 0x02, 0x0c, 0x02, 0x7f, 0x00}, /* 4d M */
  {0x7f, 0x04, 0x08, 0x10, 0x7f, 0x00}, /* 4e N */
  {0x3e, 0x41, 0x41, 0x41, 0x3e, 0x00}, /* 4f O */
  {0x7f, 0x09, 0x09, 0x09, 0x06, 0x00}, /* 50 P */
  {0x3e, 0x41, 0x51, 0x21, 0x5e, 0x00}, /* 51 Q */
  {0x7f, 0x09, 0x19, 0x29, 0x46, 0x00}, /* 52 R */
  {0x46, 0x49, 0x49, 0x49, 0x31, 0x00}, /* 53 S */
  {0x01, 0x01, 0x7f, 0x01, 0x01, 0x00}, /* 54 T */
  {0x3f, 0x40, 0x40, 0x40, 0x3f, 0x00}, /* 55 U */
  {0x1f, 0x20, 0x40, 0x20, 0x1f, 0x00}, /* 56 V */
  {0x3f, 0x40, 0x38, 0x40, 0x3f, 0x00}, /* 57 W */
  {0x63, 0x14, 0x08, 0x14, 0x63, 0x00}, /* 58 X */
  {0x07, 0x08, 0x70, 0x08, 0x07, 0x00}, /* 59 Y */
  {0x61, 0x51, 0x49, 0x45, 0x43, 0x00}, /* 5a Z */
  {0x00, 0x7f, 0x41, 0x41, 0x00, 0x00}, /* 5b [ */
  {0x02, 0x04, 0x08, 0x10, 0x20, 0x00}, /* 5c Â¥ */
  {0x00, 0x41, 0x41, 0x7f, 0x00, 0x00}, /* 5d ] */
  {0x04, 0x02, 0x01, 0x02, 0x04, 0x00}, /* 5e ^ */
  {0x40, 0x40, 0x40, 0x40, 0x40, 0x00}, /* 5f _ */
  {0x00, 0x01, 0x02, 0x04, 0x00, 0x00}, /* 60 ` */
  {0x20, 0x54, 0x54, 0x54, 0x78, 0x00}, /* 61 a */
  {0x7f, 0x48, 0x44, 0x44, 0x38, 0x00}, /* 62 b */
  {0x38, 0x44, 0x44, 0x44, 0x20, 0x00}, /* 63 c */
  {0x38, 0x44, 0x44, 0x48, 0x7f, 0x00}, /* 64 d */
  {0x38, 0x54, 0x54, 0x54, 0x18, 0x00}, /* 65 e */
  {0x08, 0x7e, 0x09, 0x01, 0x02, 0x00}, /* 66 f */
  {0x0c, 0x52, 0x52, 0x52, 0x3e, 0x00}, /* 67 g */
  {0x7f, 0x08, 0x04, 0x04, 0x78, 0x00}, /* 68 h */
  {0x00, 0x44, 0x7d, 0x40, 0x00, 0x00}, /* 69 i */
  {0x20, 0x40, 0x44, 0x3d, 0x00, 0x00}, /* 6a j */
  {0x7f, 0x10, 0x28, 0x44, 0x00, 0x00}, /* 6b k */
  {0x00, 0x41, 0x7f, 0x40, 0x00, 0x00}, /* 6c l */
  {0x7c, 0x04, 0x18, 0x04, 0x78, 0x00}, /* 6d m */
  {0x7c, 0x08, 0x04, 0x04, 0x78, 0x00}, /* 6e n */
  {0x38, 0x44, 0x44, 0x44, 0x38, 0x00}, /* 6f o */
  {0x7c, 0x14, 0x14, 0x14, 0x08, 0x00}, /* 70 p */
  {0x08, 0x14, 0x14, 0x18, 0x7c, 0x00}, /* 71 q */
  {0x7c, 0x08, 0x04, 0x04, 0x08, 0x00}, /* 72 r */
  {0x48, 0x54, 0x54, 0x54, 0x20, 0x00}, /* 73 s */
  {0x04, 0x3f, 0x44, 0x40, 0x20, 0x00}, /* 74 t */
  {0x3c, 0x40, 0x40, 0x20, 0x7c, 0x00}, /* 75 u */
  {0x1c, 0x20, 0x40, 0x20, 0x1c, 0x00}, /* 76 v */
  {0x3c, 0x40, 0x30, 0x40, 0x3c, 0x00}, /* 77 w */
  {0x44, 0x28, 0x10, 0x28, 0x44, 0x00}, /* 78 x */
  {0x0c, 0x50, 0x50, 0x50, 0x3c, 0x00}, /* 79 y */
  {0x44, 0x64, 0x54, 0x4c, 0x44, 0x00}, /* 7a z */
  {0x00, 0x08, 0x36, 0x41, 0x00, 0x00}, /* 7b { */
  {0x00, 0x00, 0x7f, 0x00, 0x00, 0x00}, /* 7c | */
  {0x00, 0x41, 0x36, 0x08, 0x00, 0x00}, /* 7d }, */
  {0x08, 0x04, 0x08, 0x10, 0x08, 0x00}  /* 7e ~ */
};

void Nokia5110_Initialize(const char *spidev, int reset_pin, int dc_pin)
{
  reset_pin_ = reset_pin;
  dc_pin_ = dc_pin;

  // Initialize GPIO
  setup_io();
  output_gpio(reset_pin_);
  output_gpio(dc_pin_);

  // Generate reset pulse (width = 100ms)
  gpio_write(reset_pin_, 0);
  usleep(100000);
  gpio_write(reset_pin_, 1);

  // Initialize SPI
  RPiSPI_Open(spidev, 0, 8, 2000000, 0);

  // Construcst initialization commands and send
  tbuff_[0] = 0x21;
  tbuff_[1] = 0x90;
  tbuff_[2] = 0x20;
  tbuff_[3] = 0x0C;
  gpio_write(dc_pin_, 0);
  RPiSPI_Transfer(tbuff_, rbuff_, 4);

  // Clear ram
  Nokia5110_Clear();
  Nokia5110_Flush();

  return;
}

void Nokia5110_RPi(void)
{
  tbuff_[0] = 0x80; // Reset X address
  tbuff_[1] = 0x40; // Reset Y address
  gpio_write(dc_pin_, 0);
  RPiSPI_Transfer(tbuff_, rbuff_, 2);
  gpio_write(dc_pin_, 1);
  RPiSPI_Transfer(rpi_logo_, rbuff_, sizeof(rpi_logo_));
  return;
}

void Nokia5110_Clear(void)
{
  int i, j;
  for(i = 0; i < sizeof(vram_); i++)
    vram_[i] = 0;
  return;
}

void Nokia5110_Flush(void)
{
  tbuff_[0] = 0x80; // Reset X address
  tbuff_[1] = 0x40; // Reset Y address
  gpio_write(dc_pin_, 0);
  RPiSPI_Transfer(tbuff_, rbuff_, 2);
  gpio_write(dc_pin_, 1);
  RPiSPI_Transfer(vram_, rbuff_, sizeof(vram_));
  return;
}

void Nokia5110_DrawChar(int x, int y, char ch)
{
  int j;
  if(' ' <= ch && ch <= '~')
    for(j = 0; j < FONT_WIDTH; j++)
      vram_[y * LCD_WIDTH + x * FONT_WIDTH + j] = ascii_[ch - ' '][j];
}

void Nokia5110_DrawString(int x, int y, const char *str)
{
  while(*str != '\0')
  {
    switch(*str)
    {
    case '\b': if(1 <= x) x--; break;
    case '\r': x = 0; break;
    case '\n': x = 0; y++; break;
    case '\t': break;
    default:
      Nokia5110_DrawChar(x, y, *str);
      if(++x == COLUMNS){ x = 0; y++; }
    }
    if(y == ROWS) break;
    str++;
  }
  return;
}

